name: Weekly Stampede Report

on:
  workflow_dispatch:       # Manual trigger button
    inputs:
      days_back:
        description: 'Number of days to look back for data'
        required: false
        default: '7'
      mode:
        description: 'Run mode'
        required: false
        default: 'weekly'
        type: choice
        options:
          - weekly
          - bootstrap
      folder_id:
        description: 'Override Drive folder ID (for targeting specific folders)'
        required: false
        default: ''
      all_files:
        description: 'Process ALL files in folder (for historical data)'
        required: false
        type: boolean
        default: false
      half:
        description: 'Half-year period for bootstrap (e.g., H1_2022)'
        required: false
        default: ''

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Bootstrap (single half-year)
        if: ${{ github.event.inputs.mode == 'bootstrap' && github.event.inputs.half != '' }}
        run: |
          python -m src.bootstrap.knowledge_builder \
            --half=${{ github.event.inputs.half }} \
            --folder=${{ github.event.inputs.folder_id }}
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Run Bootstrap (full - legacy)
        if: ${{ github.event.inputs.mode == 'bootstrap' && github.event.inputs.half == '' }}
        run: python -m src.bootstrap.knowledge_builder
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}

      - name: Commit bootstrap data
        if: ${{ github.event.inputs.mode == 'bootstrap' }}
        run: |
          git config user.name "Stampede Report Bot"
          git config user.email "bot@stampede-report"
          git add data/institutional_knowledge/
          git diff --cached --quiet || git commit -m "Bootstrap ${{ github.event.inputs.half || 'full' }}: add draft summary"
          git push

      - name: Generate Weekly Report
        if: ${{ github.event.inputs.mode != 'bootstrap' }}
        run: |
          ARGS="--days=${{ github.event.inputs.days_back || '7' }}"
          if [ -n "${{ github.event.inputs.folder_id }}" ]; then
            ARGS="$ARGS --folder=${{ github.event.inputs.folder_id }}"
          fi
          if [ "${{ github.event.inputs.all_files }}" = "true" ]; then
            ARGS="$ARGS --all"
          fi
          echo "Running: python -m src.main $ARGS"
          python -m src.main $ARGS
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
          REPORTS_FOLDER_ID: ${{ secrets.REPORTS_FOLDER_ID }}

      - name: Commit cumulative learnings
        if: ${{ github.event.inputs.mode != 'bootstrap' }}
        run: |
          git config user.name "Stampede Report Bot"
          git config user.email "bot@stampede-report"
          git add data/cumulative_learnings.json
          git diff --cached --quiet || git commit -m "Weekly: update cumulative learnings"
          git push
